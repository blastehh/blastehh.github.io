(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{320:function(a,e,t){"use strict";t.r(e);var s=t(12),r=Object(s.a)({},(function(){var a=this,e=a._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[e("h1",{attrs:{id:"opendkim"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#opendkim"}},[a._v("#")]),a._v(" OpenDKIM")]),a._v(" "),e("p",[a._v("Installing Postfix and OpenDKIM to send signed emails.")]),a._v(" "),e("p",[a._v("These instructions are written for RHEL 9 / Almalinux 9"),e("br"),a._v("\nCommands are not prepended with sudo, I will assume you know when you need to use it.")]),a._v(" "),e("hr"),a._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#install-packages"}},[a._v("Install Packages")])]),e("li",[e("a",{attrs:{href:"#setting-up-postfix"}},[a._v("Setting Up Postfix")])]),e("li",[e("a",{attrs:{href:"#setting-up-opendkim"}},[a._v("Setting Up OpenDKIM")]),e("ul",[e("li",[e("a",{attrs:{href:"#create-a-key"}},[a._v("Create a key")])]),e("li",[e("a",{attrs:{href:"#create-dns-entry"}},[a._v("Create DNS Entry")])]),e("li",[e("a",{attrs:{href:"#opendkim-configuration-file"}},[a._v("OpenDKIM Configuration File")])]),e("li",[e("a",{attrs:{href:"#create-directories-and-set-perms"}},[a._v("Create directories and set perms")])])])]),e("li",[e("a",{attrs:{href:"#start-it-all-up"}},[a._v("Start it all up")])]),e("li",[e("a",{attrs:{href:"#test"}},[a._v("Test")])])])]),e("p"),a._v(" "),e("h2",{attrs:{id:"install-packages"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-packages"}},[a._v("#")]),a._v(" Install Packages")]),a._v(" "),e("p",[a._v("The "),e("code",[a._v("OpenDKIM")]),a._v(" package is in the EPEL repo, so this needs to be installed first.")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("dnf "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" epel-release\n")])])]),e("p",[a._v("As of RHEL9/AlmaLinux9 you will need the CRB repo for some dependencies")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("dnf config-manager --set-enabled crb\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("dnf "),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" postfix opendkim opendkim-tools s-nail\n")])])]),e("h2",{attrs:{id:"setting-up-postfix"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#setting-up-postfix"}},[a._v("#")]),a._v(" Setting Up Postfix")]),a._v(" "),e("p",[a._v("Ensure the following is set in "),e("code",[a._v("/etc/postfix/main.cf")]),e("br"),a._v("\nReplace "),e("code",[a._v("<DOMAIN>")]),a._v(" with your domain that you're sending mail from."),e("br"),a._v(" "),e("code",[a._v("inet_interfaces")]),a._v(" is set to "),e("code",[a._v("localhost")]),a._v(" by default, we can change this to "),e("code",[a._v("all")]),a._v(" if we're sending mail from other hosts or from within docker."),e("br"),a._v("\nYou can further restrict who can send mail by only having "),e("code",[a._v("127.0.0.0/8")]),a._v(" for "),e("code",[a._v("mynetworks")])]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("inet_interfaces = all\nmyhostname = <DOMAIN>\nmyorigin = $myhostname\nmydestination = $myhostname, localhost.$mydomain, localhost\nmynetworks = 127.0.0.0/8 192.168.0.0/16 172.16.0.0/12 [::ffff:127.0.0.0]/104 [::1]/128\nsmtpd_milters = unix:/var/run/opendkim/opendkim.sock\nnon_smtpd_milters = $smtpd_milters\nmilter_default_action = accept\n")])])]),e("p",[a._v("Run "),e("code",[a._v("postmap /etc/postfix/main.cf")]),a._v(" once you have finished editing the file.")]),a._v(" "),e("p",[a._v("Add postfix user to opendkim group")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("usermod")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-a")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-G")]),a._v(" opendkim postfix\n")])])]),e("h2",{attrs:{id:"setting-up-opendkim"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#setting-up-opendkim"}},[a._v("#")]),a._v(" Setting Up OpenDKIM")]),a._v(" "),e("h3",{attrs:{id:"create-a-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-a-key"}},[a._v("#")]),a._v(" Create a key")]),a._v(" "),e("p",[a._v("Create the key folder:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /etc/opendkim/keys/"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("DOMAIN"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),e("p",[a._v("Generate a new key:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("opendkim-genkey "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-b")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[a._v("1024")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("DOMAIN"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-D")]),a._v(" /etc/opendkim/keys/"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("DOMAIN"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" default\n")])])]),e("p",[a._v("Set permissions:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" opendkim:opendkim "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-R")]),a._v(" /etc/opendkim/keys\n")])])]),e("p",[a._v("View your public key:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" /etc/opendkim/keys/"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("DOMAIN"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("/default.txt\ndefault._domainkey      IN      TXT     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"v=DKIM1; k=rsa; "')]),a._v("\n          "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDEag2b9X0gl5M4u26Y70CcSCYnAdOFT6Q5iY07uIzd8sOkh7hgQvnx6zYvuhCwBtMS6S464uMdCc+M/I7ozGxUTF0mcvPeuvd2ieniGR2/+2vhoawvniofsAqrUTYLVYwb2uioTJp7ryJITN9+RaMds+o6qupqkJKfLC/+USC3QQIDAQAB"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" ----- DKIM key default "),e("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("DOMAIN"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("\n")])])]),e("h3",{attrs:{id:"create-dns-entry"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-dns-entry"}},[a._v("#")]),a._v(" Create DNS Entry")]),a._v(" "),e("p",[a._v("Create a new TXT record with the name "),e("code",[a._v("default._domainkey")]),a._v(" if this is at the top level of your domain e.g. "),e("code",[a._v("example.com")]),e("br"),a._v("\nIf your domain is a subdomain such as "),e("code",[a._v("mail.example.com")]),a._v(" then use "),e("code",[a._v("default._domainkey.mail")])]),a._v(" "),e("p",[a._v("From the example key above, the contents of this TXT record will be:")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDEag2b9X0gl5M4u26Y70CcSCYnAdOFT6Q5iY07uIzd8sOkh7hgQvnx6zYvuhCwBtMS6S464uMdCc+M/I7ozGxUTF0mcvPeuvd2ieniGR2/+2vhoawvniofsAqrUTYLVYwb2uioTJp7ryJITN9+RaMds+o6qupqkJKfLC/+USC3QQIDAQAB\n")])])]),e("p",[a._v("Make sure that the quotes are removed, as well as excess spaces.")]),a._v(" "),e("h3",{attrs:{id:"opendkim-configuration-file"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#opendkim-configuration-file"}},[a._v("#")]),a._v(" OpenDKIM Configuration File")]),a._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[a._v("Note")]),a._v(" "),e("p",[a._v("If postfix runs chrooted, use "),e("code",[a._v("Socket local:/var/spool/postfix/var/run/opendkim/opendkim.sock")]),a._v(" instead")])]),a._v(" "),e("p",[a._v("Edit "),e("code",[a._v("/etc/opendkim.conf")]),a._v(" and ensure the following are set:")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("UMask 002\nMode    sv\nSocket local:/var/run/opendkim/opendkim.sock\nDomain <DOMAIN>\nKeyTable /etc/opendkim/KeyTable\nSigningTable refile:/etc/opendkim/SigningTable\nInternalHosts refile:/etc/opendkim/TrustedHosts\n")])])]),e("p",[a._v("Edit "),e("code",[a._v("/etc/opendkim/KeyTable")]),a._v(" and add:")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("default._domainkey.<DOMAIN> <DOMAIN>:default:/etc/opendkim/keys/<DOMAIN>/default.private\n")])])]),e("p",[a._v("Edit "),e("code",[a._v("/etc/opendkim/SigningTable")]),a._v(" and add:")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("*@<DOMAIN> default._domainkey.<DOMAIN>\n")])])]),e("p",[a._v("Edit "),e("code",[a._v("/etc/opendkim/TrustedHosts")]),a._v(" and add:")]),a._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[a._v("127.0.0.1\n172.16.0.0/12\n10.0.0.0/8\n192.168.0.0/16\n::1\n")])])]),e("p",[e("code",[a._v("127.0.0.1")]),a._v(" is the default entry, you can leave it as is if you're only sending from the same machine."),e("br"),a._v("\nYou will need "),e("code",[a._v("172.16.0.0/12")]),a._v(" if you're using docker containers.")]),a._v(" "),e("h3",{attrs:{id:"create-directories-and-set-perms"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-directories-and-set-perms"}},[a._v("#")]),a._v(" Create directories and set perms")]),a._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[a._v("Note")]),a._v(" "),e("p",[a._v("This step is only required if postfix runs chrooted to "),e("code",[a._v("/var/pool/postfix")])])]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-p")]),a._v(" /var/spool/postfix/var/run/opendkim\n"),e("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" opendkim:opendkim /var/spool/postfix/var/run/opendkim\n")])])]),e("h2",{attrs:{id:"start-it-all-up"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#start-it-all-up"}},[a._v("#")]),a._v(" Start it all up")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[a._v("systemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--now")]),a._v(" opendkim\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("enable")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--now")]),a._v(" postfix\n")])])]),e("h2",{attrs:{id:"test"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#test"}},[a._v("#")]),a._v(" Test")]),a._v(" "),e("p",[a._v("Send an email to an address such as your gmail to check delivery:")]),a._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"test mail"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" mail "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Test email"')]),a._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" postfix@"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("DOMAIN"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("MYACCOUNT"),e("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v("@gmail.com\n")])])]),e("p",[a._v("If you open up the original mail in gmail, it should show "),e("code",[a._v("DKIM:\t'PASS'")])]),a._v(" "),e("MediumZoom")],1)}),[],!1,null,null,null);e.default=r.exports}}]);