(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{355:function(t,s,a){"use strict";a.r(s);var e=a(12),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"powershell"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#powershell"}},[t._v("#")]),t._v(" PowerShell")]),t._v(" "),s("hr"),t._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#connect-to-remote-powershell"}},[t._v("Connect to Remote PowerShell")])]),s("li",[s("a",{attrs:{href:"#test-wmi-filter"}},[t._v("Test WMI Filter")])]),s("li",[s("a",{attrs:{href:"#list-installed-products"}},[t._v("List installed products")])]),s("li",[s("a",{attrs:{href:"#install-rsat"}},[t._v("Install RSAT")])]),s("li",[s("a",{attrs:{href:"#obtain-let-s-encrypt-certificate-for-rdp"}},[t._v("Obtain Let's Encrypt Certificate for RDP")]),s("ul",[s("li",[s("a",{attrs:{href:"#check-powershell-version"}},[t._v("Check Powershell Version")])]),s("li",[s("a",{attrs:{href:"#install-posh-acme"}},[t._v("Install Posh-ACME")])]),s("li",[s("a",{attrs:{href:"#add-powershell-script"}},[t._v("Add Powershell Script")])])])])])]),s("p"),t._v(" "),s("h2",{attrs:{id:"connect-to-remote-powershell"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#connect-to-remote-powershell"}},[t._v("#")]),t._v(" Connect to Remote PowerShell")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Enter-PSSession")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ComputerName <FQDN/IP>\n")])])]),s("h2",{attrs:{id:"test-wmi-filter"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#test-wmi-filter"}},[t._v("#")]),t._v(" Test WMI Filter")]),t._v(" "),s("p",[t._v("Easy way to test WMI filters on your local machine, example:")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("gwmi")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Query "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Select * from Win32_OperatingSystem where Caption != \"Microsoft Windows XP Professional\"'")]),t._v("\n")])])]),s("h2",{attrs:{id:"list-installed-products"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#list-installed-products"}},[t._v("#")]),t._v(" List installed products")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get-wmiobject")]),t._v(" Win32_Product "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Format-Table")]),t._v(" IdentifyingNumber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" LocalPackage "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("AutoSize\n")])])]),s("h2",{attrs:{id:"install-rsat"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-rsat"}},[t._v("#")]),t._v(" Install RSAT")]),t._v(" "),s("p",[t._v("Applicable after version 1809")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-WindowsCapability")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Name RSAT* "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Online "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Add-WindowsCapability")]),t._v(" â€“Online\n")])])]),s("p",[t._v("Check installed status")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-WindowsCapability")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Name RSAT* "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Online "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Select-Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Property DisplayName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" State\n")])])]),s("h2",{attrs:{id:"obtain-let-s-encrypt-certificate-for-rdp"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#obtain-let-s-encrypt-certificate-for-rdp"}},[t._v("#")]),t._v(" Obtain Let's Encrypt Certificate for RDP")]),t._v(" "),s("p",[t._v("This example will use DNS verification via Cloudflare")]),t._v(" "),s("h3",{attrs:{id:"check-powershell-version"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#check-powershell-version"}},[t._v("#")]),t._v(" Check Powershell Version")]),t._v(" "),s("p",[t._v("Ensure you have Powershell version 5.1 or newer")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$PSversionTable")]),t._v("\n")])])]),s("h3",{attrs:{id:"install-posh-acme"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-posh-acme"}},[t._v("#")]),t._v(" Install Posh-ACME")]),t._v(" "),s("p",[t._v("Install "),s("a",{attrs:{href:"https://github.com/rmbolger/Posh-ACME",target:"_blank",rel:"noopener noreferrer"}},[t._v("Posh-ACME"),s("OutboundLink")],1),t._v("\nIf you installed this a while ago, make sure you update to a version >3.10.0")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Install-Module")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Name Posh-ACME\n")])])]),s("h3",{attrs:{id:"add-powershell-script"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#add-powershell-script"}},[t._v("#")]),t._v(" Add Powershell Script")]),t._v(" "),s("p",[t._v("Using the example "),s("a",{attrs:{href:"https://github.com/rmbolger/Posh-ACME/blob/master/Posh-ACME/DnsPlugins/Cloudflare-Readme.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CFParams")]),t._v(" = @"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CFAuthEmail="),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxxxxxxx'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" CFAuthKey="),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxxxxxxx'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("New-PACertificate")]),t._v(" test"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("example"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("DnsPlugin Cloudflare "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("PluginArgs "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CFParams")]),t._v("\n")])])]),s("p",[t._v("Here's a script to renew and then set the certificate as the current RDP cert")]),t._v(" "),s("div",{staticClass:"language-powershell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-powershell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Change your settings here")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$certDomain")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"YOUR.DOMAIN.COM"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$emailAddr")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"YOUR@EMAIL.com"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cfKey")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CLOUDFLAREAPIKEY"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Don't touch below here")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$evSource")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Let\'s Encrypt Cert Renew"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("[System.Diagnostics.EventLog]")]),t._v("::Exists"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Application'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-and")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("[System.Diagnostics.EventLog]")]),t._v("::SourceExists"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$evSource")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("New-EventLog")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("LogName Application "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Source "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$evSource")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$myHostName")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("[System.Net.Dns]")]),t._v("::GetHostByName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$env")]),t._v(":computerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HostName\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$text")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-EventLog")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("LogName Application "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Source "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$evSource")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("EntryType Information "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("EventID 1 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Message "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$text")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Function")]),t._v(" Renew-Cert "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set-PAServer")]),t._v(" LE_PROD\n    "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CFParams")]),t._v(" = @"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CFAuthEmail="),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$emailAddr")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" CFAuthKey="),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cfKey")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$certDetails")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("New-PACertificate")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$certDomain")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("AcceptTOS "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Contact "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$emailAddr")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("DnsPlugin Cloudflare "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("PluginArgs "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CFParams")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Install\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$certDetails")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("[string]")]),t._v("::IsNullOrEmpty"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$certDetails")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Thumbprint"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStoreScope")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'LocalMachine'")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStorename")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'My'")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStoreScope")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'LocalMachine'")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStoreName")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Remote Desktop'")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$newThumb")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$certDetails")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Thumbprint\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStore")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("New-Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("TypeName System"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Security"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cryptography"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("X509Certificates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("X509Store  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ArgumentList "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStorename")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStoreScope")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Open"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("[System.Security.Cryptography.X509Certificates.OpenFlags]")]),t._v("::ReadOnly"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cert")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Certificates "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Where-Object")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("FilterScript "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Thumbprint "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-like")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$newThumb")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            \n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStore")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("New-Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("TypeName System"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Security"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Cryptography"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("X509Certificates"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("X509Store  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("ArgumentList "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStoreName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStoreScope")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Open"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("[System.Security.Cryptography.X509Certificates.OpenFlags]")]),t._v("::ReadWrite"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Add"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$cert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$SourceStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Close"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$DestStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Close"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"New cert copied to Remote Desktop store"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            \n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Set-WmiInstance")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Path "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$rdpProp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("__path "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("argument @"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("SSLCertificateSHA1Hash="),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$newThumb")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"New RDP cert set"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Failed to renew"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Running..."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Cleanup old Certs")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-ChildItem")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Cert:\\LocalMachine\\My'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Recurse "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Where-Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hasprivatekey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-and")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("notafter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-lt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AddDays"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Remove-Item")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-ChildItem")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Cert:\\LocalMachine\\Remote Desktop'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Recurse "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Where-Object")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("hasprivatekey "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-and")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("notafter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-lt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AddDays"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Remove-Item")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$rdpProp")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-WmiObject")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Win32_TSGeneralSetting"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Namespace root\\cimv2\\terminalservices "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("Filter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"TerminalName='RDP-tcp'\"")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$currentCert")]),t._v(" = "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-ChildItem")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Cert:\\LocalMachine\\Remote Desktop'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Recurse "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Where-Object")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("FilterScript "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Thumbprint "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-like")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$rdpProp")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SSLCertificateSHA1Hash"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-and")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$_")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Issuer "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-notlike")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CN="')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$myHostName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$currentCert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"No cert found, renewing!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    Renew-Cert\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("elseif")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$currentCert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("NotAfter "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-lt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Get-Date")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AddDays"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("30"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Current cert is expiring within 30 days, renewing!"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    Renew-Cert\n    \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"No renewal needed"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Write-LogEntry")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Finished Running"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("MediumZoom")],1)}),[],!1,null,null,null);s.default=n.exports}}]);